#!/bin/sh

# Claude code command to create tutorials for topics.
# 
# This script reads the topics directory.
# 
# For each topic:
# 
# 1. Read the topic directory file `index.md` for gathering context.
# 2. Set a prompt, then generate the tutorial text, then print to stdout.
# 3. Save the tutorial text to new file `tutorial-by-claude-opus-4-5.md`.
# 
# This script is designed to work in parallel with multiple runs,
# meaning you can launch this script multiple simultanous times,
# and all the runs will try to stay out of each other's way.

set -euf
top="$(git rev-parse --show-toplevel)"

# Delete any extraneous tutorial files; these are sometimes created
# when Claude starts to think about a tutorial yet doesn't finish.
find "$HOME/git/sixarm/topics/topics" -type f -name tutorial-by-claude-opus-4-5.md -empty -delete

# Find all the topcs that need tutorials.
# Shuffle the topics to help multiple runs mitigate overlap.
find "$HOME/git/sixarm/topics/topics" -type d -depth 1 |
xargs basename |
shuf |
while read -r topic; do
    
    # Memoize the topic directory full path.
    dir="$top/topics/$topic"

    # Verify the topic directory exists, and has its expected file `index.md`,
    # and needs us to create its new file `tutorial-by-claude-opus-4-5.md`.
    # This helps ensure we can run this claud script in parallal with others,
    # and can make dynamic changes to the directories and files out of band.
    if [ ! -e "$dir" ] || [ ! -f "$dir/index.md" ] || [ -f "$dir/tutorial-by-claude-opus-4-5.md" ]; then continue; fi;

    # Create a specific prompt that generates the phrasing that we prefer.
    # We ensure claude prints to stdout, and doesn't try to write a file.
    prompt=$(cat<<-EOF
Create comprehensive tutorial explaining topic **$topic** for a technology professional.
Read input file "$dir/index.md"
Use clear H2 headers, paragraphs, tables for comparisons, bullet lists. Be decisive.
Do not use ASCII diagrams. Do not use source code.
Print the markdown tutorial directly. Do not use the Write tool.
EOF
    )
    echo "$topic"
    claude \
    --print "$prompt" \
    --add-dir "$dir" \
    --model claude-opus-4-5-20251101 \
    --allowedTools "Read" \
    --no-session-persistence \
    </dev/null \
    >"$dir/tutorial-by-claude-opus-4-5.md"
done
